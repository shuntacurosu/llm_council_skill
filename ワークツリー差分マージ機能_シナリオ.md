# ワークツリー差分マージ機能 - テストシナリオ

## 概要

LLM Councilの`--worktrees`オプションを使用した場合、各Council Memberが独立したgit worktreeで作業を行い、最終的に最優秀の提案をメインブランチにマージする機能のテストシナリオ集。

---

## 機能仕様

### 現在の動作
1. 各Council Memberに専用のworktreeを作成
2. 各Memberがworktree内でコード変更を実施
3. 変更差分（diff）を取得してピアレビュー
4. Chairmanが統合レスポンスを生成
5. worktreeをクリーンアップ（**差分は破棄される**）

### 追加予定の機能
- **最優秀提案の自動マージ**: Aggregate Rankingで1位の提案をmainブランチにマージ
- **手動選択マージ**: ユーザーが指定したMemberの提案をマージ
- **マージ前確認**: diffを表示してユーザー確認後にマージ
- **コンフリクト処理**: マージ時の競合解決

---

## テストシナリオ

### シナリオ1: 新規ファイル作成（シンプル）

**目的**: 新しいファイルを作成する最もシンプルなケース

**クエリ例**:
```
scripts/ディレクトリに hello.py を作成して。"Hello, World!"を出力する簡単なスクリプトで。
```

**期待動作**:
1. 各Memberがworktreeで`hello.py`を作成
2. 差分が`新規ファイル追加`として検出される
3. ピアレビューで最優秀を選定
4. 選ばれた提案がmainにマージされ、`scripts/hello.py`が存在

**確認ポイント**:
- [ ] 新規ファイルが正しく作成される
- [ ] 各Memberの差分が取得できる
- [ ] マージ後にファイルが存在する

---

### シナリオ2: 既存ファイルの修正（バグ修正）

**目的**: 既存コードのバグを修正するケース

**準備**: `scripts/buggy.py`を事前に作成
```python
def divide(a, b):
    return a / b  # ゼロ除算エラーの可能性
```

**クエリ例**:
```
scripts/buggy.py の divide関数にゼロ除算エラーのハンドリングを追加して
```

**期待動作**:
1. 各Memberが異なるエラーハンドリング方法を提案
   - 例: try-except、事前チェック、デフォルト値返却など
2. ピアレビューで最適な方法を選定
3. 選ばれた修正がmainにマージ

**確認ポイント**:
- [ ] 既存ファイルが正しく修正される
- [ ] 差分が`変更`として検出される
- [ ] マージ後に修正が反映されている

---

### シナリオ3: 複数ファイルの変更（リファクタリング）

**目的**: 複数ファイルにまたがる変更

**クエリ例**:
```
scripts/config.py の設定読み込みロジックを別ファイル scripts/config_loader.py に分離して
```

**期待動作**:
1. 各Memberが独自のリファクタリング案を提示
2. `config.py`の修正 + `config_loader.py`の新規作成
3. 複数ファイルの差分がまとめてレビュー対象

**確認ポイント**:
- [ ] 複数ファイルの差分が正しく取得される
- [ ] マージ時に全ファイルが反映される
- [ ] 依存関係が壊れていない

---

### シナリオ4: 仕様検討（コード変更なし）

**目的**: コード変更ではなく、設計・仕様の議論

**クエリ例**:
```
このプロジェクトにキャッシュ機能を追加したい。どのような設計がよいか検討して
```

**期待動作**:
1. 各Memberが設計案をテキストで回答
2. worktreeに変更なし（diffは空）
3. ピアレビューは回答内容で評価
4. マージは不要（コード変更なし）

**確認ポイント**:
- [ ] diffが空の場合でも正常動作
- [ ] マージスキップが適切に判定される
- [ ] 結果表示は通常通り

---

### シナリオ5: コンフリクト発生ケース

**目的**: 同じファイルの同じ箇所を異なる方法で変更

**準備**: `scripts/target.py`
```python
def calculate(x):
    return x * 2
```

**クエリ例**:
```
scripts/target.py の calculate関数を改良して。性能を向上させるか、機能を拡張するか、どちらかのアプローチで
```

**期待動作**:
1. Member Aが性能向上版を提案
2. Member Bが機能拡張版を提案
3. 両方が同じ関数を変更→コンフリクト可能性
4. マージ時にコンフリクト検出・解決

**確認ポイント**:
- [ ] コンフリクトが正しく検出される
- [ ] コンフリクト時のユーザーへの通知
- [ ] 解決オプションの提示

---

### シナリオ6: ユーザーによる手動選択

**目的**: Aggregate Ranking 1位ではなく、ユーザーが指定したMemberの提案をマージ

**クエリ例**:
```
scripts/utils.py に便利な関数を追加して
```

**追加オプション**:
```bash
python council_skill.py --worktrees --merge 2 "クエリ"
# Member 2の提案を強制的にマージ
```

**期待動作**:
1. 通常通りCouncil実行
2. Ranking結果に関わらず、指定Memberの差分をマージ

**確認ポイント**:
- [ ] `--merge N` オプションが機能する
- [ ] 指定Memberの差分が正しくマージされる

---

### シナリオ7: マージ前の確認プロンプト

**目的**: 自動マージ前にユーザー確認を挟む

**クエリ例**:
```
scripts/important.py を改善して
```

**オプション**:
```bash
python council_skill.py --worktrees --confirm "クエリ"
# マージ前に確認を求める
```

**期待動作**:
1. Council実行完了
2. 最優秀提案の差分を表示
3. 「マージしますか？ [y/N]」を表示
4. ユーザー入力に応じてマージ実行/スキップ

**確認ポイント**:
- [ ] 差分プレビューが表示される
- [ ] ユーザー入力が正しく処理される
- [ ] `N`でスキップ、`y`でマージ

---

### シナリオ8: ドライラン（マージせずに差分のみ確認）

**目的**: 実際にはマージせず、結果だけ確認

**オプション**:
```bash
python council_skill.py --worktrees --dry-run "クエリ"
```

**期待動作**:
1. Council実行
2. 各Memberの差分を表示
3. マージは実行しない
4. worktreeはクリーンアップ

**確認ポイント**:
- [ ] マージが実行されない
- [ ] 差分は正しく表示される
- [ ] worktreeはクリーンアップされる

---

### シナリオ9: エラーハンドリング（worktree作成失敗）

**目的**: worktree作成に失敗した場合の動作

**シミュレーション**:
- ディスク容量不足
- 権限エラー
- ブランチ名の競合

**期待動作**:
1. エラーをログに記録
2. 可能な限り他のMemberは続行
3. 部分的な結果を返す or 全体をエラー終了

**確認ポイント**:
- [ ] エラーメッセージが明確
- [ ] 部分成功の場合の結果表示
- [ ] クリーンアップが確実に実行される

---

### シナリオ10: 大規模変更（テストプロジェクト全体の生成）

**目的**: 多数のファイルを一度に生成

**クエリ例**:
```
scripts/test_project/ ディレクトリに、簡単なFlask APIプロジェクトを作成して。
app.py, routes.py, models.py, requirements.txt を含むこと。
```

**期待動作**:
1. 各Memberが複数ファイルを生成
2. 全ファイルの差分をまとめてレビュー
3. マージ時に全ファイルが反映

**確認ポイント**:
- [ ] 多数ファイルの差分が正しく取得される
- [ ] マージ時にディレクトリ構造が維持される
- [ ] 大きな差分でも処理できる

---

## 実装優先度

| 優先度 | シナリオ | 理由 |
|--------|----------|------|
| 🔴 高 | シナリオ1, 2 | 基本動作の確認 |
| 🔴 高 | シナリオ8 | 安全なテスト環境 |
| 🟡 中 | シナリオ3, 4, 6 | 実用的なユースケース |
| 🟡 中 | シナリオ7 | ユーザー体験向上 |
| 🟢 低 | シナリオ5, 9, 10 | エッジケース対応 |

---

## 実装ステップ

### Phase 1: 基本マージ機能
1. `--auto-merge` オプション追加
2. Aggregate Ranking 1位の差分をマージ
3. シナリオ1, 2 で動作確認

### Phase 2: ユーザー制御
1. `--dry-run` オプション追加
2. `--confirm` オプション追加
3. `--merge N` オプション追加
4. シナリオ6, 7, 8 で動作確認

### Phase 3: エッジケース対応
1. コンフリクト検出・通知
2. エラーハンドリング強化
3. 複数ファイル・大規模変更対応
4. シナリオ3, 5, 9, 10 で動作確認

---

## コマンドライン引数案

```bash
# 基本（マージなし、現在の動作）
python council_skill.py --worktrees "クエリ"

# 自動マージ（1位の提案を自動マージ）
python council_skill.py --worktrees --auto-merge "クエリ"

# 確認付きマージ
python council_skill.py --worktrees --confirm "クエリ"

# 手動選択マージ（Member 2を指定）
python council_skill.py --worktrees --merge 2 "クエリ"

# ドライラン（マージせず差分確認のみ）
python council_skill.py --worktrees --dry-run "クエリ"
```

---

## 注意事項

1. **安全性**: 本番環境のコードを破壊しないよう、デフォルトはマージなし
2. **ロールバック**: マージ後に問題があった場合の復元手段を用意
3. **ログ**: マージ履歴を記録して追跡可能に
4. **テスト環境**: 最初はテスト用ディレクトリで動作確認
